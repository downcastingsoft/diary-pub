<?xml version="1.0"?>
<i:article
  xmlns:i="http://www.downcastingsoft.net/2021/IJKML">

<i:head>
  <i:author>hnagamin</i:author>
  <i:created-at>2023-06-14 12:17:14</i:created-at>
  <i:updated-at>2023-06-14 12:17:14</i:updated-at>
</i:head>

<i:title>ポアソン到着とタイムスタンプ</i:title>

<i:summary>
  ポアソン分布に従って到着するリクエストを到着時刻のタイムスタンプで処理する場合にタイムスタンプが衝突する確率を計算する．
</i:summary>

<i:body>

<i:section sid="intro">
<i:title>はじめに</i:title>

<i:p>
ここでは以下の問題を考えます．
</i:p>
<blockquote class="twitter-tweet"><p lang="ja" dir="ltr">ファイル名を秒からミリ秒にするの、ランダムな分布を仮定するとしても誕生日だから1000倍の余裕ができるというわけではなくもっと小さいんじゃないかなと直感的には予想するけどどれぐらいなんだろう。</p>&mdash; 久我山菜々+ (@nonamea774) <a href="https://twitter.com/nonamea774/status/1658682102874001409?ref_src=twsrc%5Etfw">May 17, 2023</a></blockquote>
<script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

<i:p>
衝突確率とタイムスタンプの間隔，リクエストの到着率の関係は
<i:cite bid="wass80" /> で既に議論されているので，ここではもう少し具体的な数値を挙げて計算します．
</i:p>

</i:section> <!-- @sid="intro" -->

<i:section sid="p">
<i:title>衝突確率</i:title>

<i:p>
ポアソン分布に従って，一定期間（たとえば1日）の間にリクエストが平均 <math><mi>λ</mi></math> 件到着する状況を考える．
期間を <math><mi>N</mi></math> 等分したタイムスタンプを用いてリクエストを処理するとする．
このとき，リクエストのタイムスタンプが衝突する確率 <math><mi>p</mi></math> を求めたい．
そのために，余事象として衝突しない確率を考える．

最初のタイムスタンプ1区間のうちに1件到着し，以降1件も到着しない確率は
<math display="block">
  <mrow>
    <mrow>
      <mrow>
        <mfrac>
          <mi>&#x3BB;</mi>
          <mi>N</mi>
        </mfrac>
        <mo>&#x2062;</mo>
        <msup>
          <mi>e</mi>
          <mrow>
            <mo>-</mo>
            <mi>&#x3BB;</mi>
            <mo>/</mo>
            <mi>N</mi>
          </mrow>
        </msup>
      </mrow>
      <mo>&#xD7;</mo>
      <msup>
        <mi>e</mi>
        <mrow>
          <mo>-</mo>
          <mi>&#x3BB;</mi>
          <mo>/</mo>
          <mi>N</mi>
        </mrow>
      </msup>
      <mo>&#xD7;</mo>
      <mo>&#x22EF;</mo>
      <mo>&#xD7;</mo>
      <msup>
        <mi>e</mi>
        <mrow>
          <mo>-</mo>
          <mi>&#x3BB;</mi>
          <mo>/</mo>
          <mi>N</mi>
        </mrow>
      </msup>
    </mrow>
    <mo>=</mo>
    <mrow>
      <mfrac>
        <mi>&#x3BB;</mi>
        <mi>N</mi>
      </mfrac>
      <mo>&#x2062;</mo>
      <msup>
        <mi>e</mi>
        <mrow>
          <mo>-</mo>
          <mi>&#x3BB;</mi>
        </mrow>
      </msup>
    </mrow>
  </mrow>
</math>
である．
タイムスタンプを1つ選ぶ方法は <math><mi>N</mi></math> 通りあるので，
一定期間のうちに1件到着し，なおかつタイムスタンプが衝突しない確率
<math><msub><mi>q</mi><mn>1</mn></msub></math> は
<math display="block">
  <mrow>
    <msub>
      <mi>q</mi>
      <mn>1</mn>
    </msub>
    <mo>=</mo>
    <mrow>
      <mi>N</mi>
      <mo>&#xD7;</mo>
      <mrow>
        <mfrac>
          <mi>&#x3BB;</mi>
          <mi>N</mi>
        </mfrac>
        <mo>&#x2062;</mo>
        <msup>
          <mi>e</mi>
          <mrow>
            <mo>-</mo>
            <mi>&#x3BB;</mi>
          </mrow>
        </msup>
      </mrow>
    </mrow>
  </mrow>
</math>
となる．
次に，一定期間のうちに2件到着する場合を考える．
たとえば，最初のタイムスタンプ2区間のうちに1件ずつ到着し，以降1件も到着しない確率は
<math display="block">
  <mrow>
    <mrow>
      <mfrac>
        <mi>&#x3BB;</mi>
        <mi>N</mi>
      </mfrac>
      <mo>&#x2062;</mo>
      <msup>
        <mi>e</mi>
        <mrow>
          <mo>-</mo>
          <mi>&#x3BB;</mi>
          <mo>/</mo>
          <mi>N</mi>
        </mrow>
      </msup>
      <mo>&#xD7;</mo>
      <mfrac>
        <mi>&#x3BB;</mi>
        <mi>N</mi>
      </mfrac>
      <mo>&#x2062;</mo>
      <msup>
        <mi>e</mi>
        <mrow>
          <mo>-</mo>
          <mi>&#x3BB;</mi>
          <mo>/</mo>
          <mi>N</mi>
        </mrow>
      </msup>
      <mo>&#xD7;</mo>
      <msup>
        <mi>e</mi>
        <mrow>
          <mo>-</mo>
          <mi>&#x3BB;</mi>
          <mo>/</mo>
          <mi>N</mi>
        </mrow>
      </msup>
      <mo>&#xD7;</mo>
      <mo>&#x22EF;</mo>
      <mo>&#xD7;</mo>
      <msup>
        <mi>e</mi>
        <mrow>
          <mo>-</mo>
          <mi>&#x3BB;</mi>
          <mo>/</mo>
          <mi>N</mi>
        </mrow>
      </msup>
    </mrow>
    <mo>=</mo>
    <mrow>
      <msup>
        <mrow>
          <mo>(</mo>
          <mfrac>
            <mi>&#x3BB;</mi>
            <mi>N</mi>
          </mfrac>
          <mo>)</mo>
        </mrow>
        <mn>2</mn>
      </msup>
      <mo>&#x2062;</mo>
      <msup>
        <mi>e</mi>
        <mrow>
          <mo>-</mo>
          <mi>&#x3BB;</mi>
        </mrow>
      </msup>
    </mrow>
  </mrow>
</math>
である．
タイムスタンプを2つ選ぶ方法は
<math>
  <mrow>
    <mi>N</mi>
    <mo>&#x2062;</mo>
    <mrow>
      <mo>(</mo>
      <mi>N</mi>
      <mo>-</mo>
      <mn>1</mn>
      <mo>)</mo>
    </mrow>
    <mo>/</mo>
    <mn>2</mn>
  </mrow>
</math>
通りあるので，
一定期間のうちに2件到着し，なおかつタイムスタンプが衝突しない確率
<math>
  <msub>
    <mi>q</mi>
    <mn>2</mn>
  </msub>
</math>
は
<math display="block">
  <mrow>
    <msub>
      <mi>q</mi>
      <mn>2</mn>
    </msub>
    <mo>=</mo>
    <mfrac>
      <mrow>
        <mi>N</mi>
        <mo>&#x2062;</mo>
        <mrow>
          <mo>(</mo>
          <mi>N</mi>
          <mo>-</mo>
          <mn>1</mn>
          <mo>)</mo>
        </mrow>
      </mrow>
      <mn>2</mn>
    </mfrac>
    <mo>&#xD7;</mo>
    <mrow>
      <msup>
        <mrow>
          <mo>(</mo>
          <mfrac>
            <mi>&#x3BB;</mi>
            <mi>N</mi>
          </mfrac>
          <mo>)</mo>
        </mrow>
        <mn>2</mn>
      </msup>
      <mo>&#x2062;</mo>
      <msup>
        <mi>e</mi>
        <mrow>
          <mo>-</mo>
          <mi>&#x3BB;</mi>
        </mrow>
      </msup>
    </mrow>
  </mrow>
</math>
となる．

同様にして，一定期間のうちに
<math><mi>k</mi></math> 件到着し，なおかつタイムスタンプが衝突しない確率
<math>
  <msub>
    <mi>q</mi>
    <mi>k</mi>
  </msub>
</math>
は，二項係数を用いて次のように書ける．
<math display="block">
  <mrow>
    <msub>
      <mi>q</mi>
      <mi>k</mi>
    </msub>
    <mo>=</mo>
    <mrow>
      <mrow>
        <mo>(</mo>
        <mfrac linethickness="0">
          <mi>N</mi>
          <mi>k</mi>
        </mfrac>
        <mo>)</mo>
      </mrow>
      <mo>&#x2062;</mo>
      <msup>
        <mrow>
          <mo>(</mo>
          <mfrac>
            <mi>&#x3BB;</mi>
            <mi>N</mi>
          </mfrac>
          <mo>)</mo>
        </mrow>
        <mi>k</mi>
      </msup>
      <mo>&#x2062;</mo>
      <msup>
        <mi>e</mi>
        <mrow>
          <mo>-</mo>
          <mi>&#x3BB;</mi>
        </mrow>
      </msup>
    </mrow>
  </mrow>
</math>

</i:p>

<i:p>
よって，二項定理より衝突する確率 <math><mi>p</mi></math> は以下のようになる．
<math display="block">
  <mrow>
    <mi>p</mi>
    <mo>=</mo>
    <mrow>
      <mn>1</mn>
      <mo>-</mo>
      <mrow>
        <munderover>
          <mi>&#x2211;</mi>
          <mrow>
            <mi>k</mi>
            <mo>=</mo>
            <mn>0</mn>
          </mrow>
          <mi>N</mi>
        </munderover>
        <msub>
          <mi>q</mi>
          <mi>k</mi>
        </msub>
      </mrow>
    </mrow>
    <mo>=</mo>
    <mrow>
      <mn>1</mn>
      <mo>-</mo>
      <mrow>
        <munderover>
          <mi>&#x2211;</mi>
          <mrow>
            <mi>k</mi>
            <mo>=</mo>
            <mn>0</mn>
          </mrow>
          <mi>N</mi>
        </munderover>
        <mrow>
          <mrow>
            <mo>(</mo>
            <mfrac linethickness="0">
              <mi>N</mi>
              <mi>k</mi>
            </mfrac>
            <mo>)</mo>
          </mrow>
          <mo>&#x2062;</mo>
          <msup>
            <mrow>
              <mo>(</mo>
              <mfrac>
                <mi>&#x3BB;</mi>
                <mi>N</mi>
              </mfrac>
              <mo>)</mo>
            </mrow>
            <mi>k</mi>
          </msup>
          <mo>&#x2062;</mo>
          <msup>
            <mi>e</mi>
            <mrow>
              <mo>-</mo>
              <mi>&#x3BB;</mi>
            </mrow>
          </msup>
        </mrow>
      </mrow>
    </mrow>
    <mo>=</mo>
    <mrow>
      <mn>1</mn>
      <mo>-</mo>
      <mrow>
        <msup>
          <mi>e</mi>
          <mrow>
            <mo>-</mo>
            <mi>&#x3BB;</mi>
          </mrow>
        </msup>
        <mo>&#x2062;</mo>
        <msup>
          <mrow>
            <mo>(</mo>
            <mn>1</mn>
            <mo>+</mo>
            <mfrac>
              <mi>&#x3BB;</mi>
              <mi>N</mi>
            </mfrac>
            <mo>)</mo>
          </mrow>
          <mi>N</mi>
        </msup>
      </mrow>
    </mrow>
  </mrow>
</math>
</i:p>

<i:p>
また，到着率 <math><mi>λ</mi></math> について整理すると，
ランベルトのW関数を用いて次のように書ける．
<math display="block">
  <mrow>
    <mi>&#x3BB;</mi>
    <mo>=</mo>
    <mrow>
      <mo>-</mo>
      <mi>N</mi>
      <mo>&#x2062;</mo>
      <mrow>
        <mo>(</mo>
        <mrow>
          <msub>
            <mi>W</mi>
            <mn>-1</mn>
          </msub>
          <mo>&#x2061;</mo>
          <mrow>
            <mo>(</mo>
            <mo>-</mo>
            <mfrac>
              <mroot>
                <mrow>
                  <mn>1</mn>
                  <mo>-</mo>
                  <mi>p</mi>
                </mrow>
                <mi>N</mi>
              </mroot>
              <mi>e</mi>
            </mfrac>
            <mo>)</mo>
          </mrow>
        </mrow>
        <mo>+</mo>
        <mn>1</mn>
        <mo>)</mo>
      </mrow>
    </mrow>
  </mrow>
</math>
</i:p>

</i:section> <!-- @sid="p" -->

<i:section sid="approx">
<i:title>近似式</i:title>

<i:p>

<math>
  <mrow>
    <mi>&#x3B1;</mi>
    <mo>=</mo>
    <mrow>
      <mi>&#x3BB;</mi>
      <mo>/</mo>
      <mi>N</mi>
    </mrow>
  </mrow>
</math>
とおく．
<math>
  <msup>
    <mi>e</mi>
    <mrow>
      <mo>-</mo>
      <mi>x</mi>
    </mrow>
  </msup>
</math>
のテイラー展開を使うと次式を得る．
<math display="block">
  <mrow>
    <mi>p</mi>
    <mo>=</mo>
    <mrow>
      <mn>1</mn>
      <mo>-</mo>
      <mrow>
        <msup>
          <mi>e</mi>
          <mrow>
            <mo>-</mo>
            <mi>&#x3BB;</mi>
          </mrow>
        </msup>
        <mo>&#x2062;</mo>
        <msup>
          <mrow>
            <mo>(</mo>
            <mn>1</mn>
            <mo>+</mo>
            <mfrac>
              <mi>&#x3BB;</mi>
              <mi>N</mi>
            </mfrac>
            <mo>)</mo>
          </mrow>
          <mi>N</mi>
        </msup>
      </mrow>
    </mrow>
    <mo>=</mo>
    <mrow>
      <mn>1</mn>
      <mo>-</mo>
      <msup>
        <mrow>
          <mo>(</mo>
          <mfrac>
            <mrow>
              <mn>1</mn>
              <mo>+</mo>
              <mi>&#x3B1;</mi>
            </mrow>
            <msup>
              <mi>e</mi>
              <mi>&#x3B1;</mi>
            </msup>
          </mfrac>
          <mo>)</mo>
        </mrow>
        <mi>N</mi>
      </msup>
    </mrow>
    <mo>&#x2248;</mo>
    <mrow>
      <mn>1</mn>
      <mo>-</mo>
      <msup>
        <mrow>
          <mo>(</mo>
          <mn>1</mn>
          <mo>-</mo>
          <mfrac>
            <msup>
              <mi>&#x3B1;</mi>
              <mn>2</mn>
            </msup>
            <mn>2</mn>
          </mfrac>
          <mo>)</mo>
        </mrow>
        <mi>N</mi>
      </msup>
    </mrow>
  </mrow>
</math>
これと
<math>
  <mrow>
    <msup>
      <mrow>
        <mo>(</mo>
        <mn>1</mn>
        <mo>-</mo>
        <mi>x</mi>
        <mo>)</mo>
      </mrow>
      <mi>N</mi>
    </msup>
    <mo>&#x2248;</mo>
    <mrow>
      <mn>1</mn>
      <mo>-</mo>
      <mrow>
        <mi>N</mi>
        <mo>&#x2062;</mo>
        <mi>x</mi>
      </mrow>
    </mrow>
  </mrow>
</math>
より衝突確率 <math><mi>p</mi></math> は次のように近似できる．
<math display="block">
  <mrow>
    <mi>p</mi>
    <mo>&#x2248;</mo>
    <mfrac>
      <mrow>
        <mi>N</mi>
        <mo>&#x2062;</mo>
        <msup>
          <mi>&#x3B1;</mi>
          <mn>2</mn>
        </msup>
      </mrow>
      <mn>2</mn>
    </mfrac>
    <mo>=</mo>
    <mfrac>
      <msup>
        <mi>&#x3BB;</mi>
        <mn>2</mn>
      </msup>
      <mrow>
        <mn>2</mn>
        <mo>&#x2062;</mo>
        <mi>N</mi>
      </mrow>
    </mfrac>
  </mrow>
</math>
</i:p>

<i:p>
また，リクエストの到着率 <math><mi>λ</mi></math> は次のように近似できる．
<math display="block">
  <mrow>
    <mi>&#x3BB;</mi>
    <mo>&#x2248;</mo>
    <msqrt>
      <mrow>
        <mn>2</mn>
        <mo>&#x2062;</mo>
        <mi>N</mi>
        <mo>&#x2062;</mo>
        <mi>p</mi>
      </mrow>
    </msqrt>
  </mrow>
</math>
</i:p>

</i:section> <!-- @sid="approx" -->


<i:section sid="numer">
<i:title>数値例</i:title>

<i:p>

1日あたりの衝突確率を1%まで許容しながらリクエストを秒単位のタイムスタンプで処理する場合，
どのくらい多くののリクエストを処理できるか考えます．
1日は86400秒なので
<math>
  <mrow>
    <mi>N</mi>
    <mo>=</mo>
    <mn>86400</mn>
  </mrow>
  <mo>,</mo>
  <mrow>
    <mi>p</mi>
    <mo>=</mo>
    <mn>0.01</mn>
  </mrow>
</math>
となる到着率 <math><mi>λ</mi></math> を求めればよいです．

<math display="block">
  <mrow>
    <mi>&#x3BB;</mi>
    <mo>&#x2248;</mo>
    <msqrt>
      <mrow>
        <mn>2</mn>
        <mo>&#xD7;</mo>
        <mn>864</mn>
      </mrow>
    </msqrt>
    <mo>=</mo>
    <mrow>
      <mn>24</mn>
      <mo>&#x2062;</mo>
      <msqrt>
        <mn>3</mn>
      </msqrt>
    </mrow>
    <mo>&#x2248;</mo>
    <mn>42</mn>
  </mrow>
</math>
実際には41.68件/日なのでそこそこ正確です．
1日あたり1%まで許容しても40件程度しか処理できないのは意外でした．
ミリ秒単位で処理する場合は
<math display="block">
  <mrow>
    <mi>&#x3BB;</mi>
    <mo>&#x2248;</mo>
    <msqrt>
      <mrow>
        <mn>2</mn>
        <mo>&#xD7;</mo>
        <mn>864000</mn>
      </mrow>
    </msqrt>
    <mo>&#x2248;</mo>
    <mn>1315</mn>
  </mrow>
</math>
となり，およそ32倍のリクエストを処理できるようになります．
1000倍にならない点が誕生日のパラドックスに似ているかもしれません．
他のケースについて計算した結果を以下に示します．
</i:p>

<table>
  <thead>
    <th>期間</th>
    <th>間隔</th>
    <th>衝突確率</th>
    <th>到着率</th>
  </thead>
  <tbody style="text-align: right;">
    <tr>
      <td>1日</td>
      <td>1秒</td>
      <td>1%</td>
      <td>42件/日</td>
    </tr>
    <tr>
      <td>1日</td>
      <td>1秒</td>
      <td>0.1%</td>
      <td>13件/日</td>
    </tr>
    <tr>
      <td>1日</td>
      <td>1秒</td>
      <td>0.01%</td>
      <td>4件/日</td>
    </tr>
    <tr>
      <td>1日</td>
      <td>1ミリ秒</td>
      <td>1%</td>
      <td>1300件/日</td>
    </tr>
    <tr>
      <td>1日</td>
      <td>1ミリ秒</td>
      <td>0.1%</td>
      <td>420件/日</td>
    </tr>
    <tr>
      <td>1日</td>
      <td>1ミリ秒</td>
      <td>0.01%</td>
      <td>130件/日</td>
    </tr>
    <tr>
      <td>1年</td>
      <td>1秒</td>
      <td>1%</td>
      <td>800件/年</td>
    </tr>
    <tr>
      <td>1年</td>
      <td>1秒</td>
      <td>0.1%</td>
      <td>250件/年</td>
    </tr>
    <tr>
      <td>1年</td>
      <td>1秒</td>
      <td>0.01%</td>
      <td>80件/年</td>
    </tr>
    <tr>
      <td>1年</td>
      <td>1ミリ秒</td>
      <td>1%</td>
      <td>25000件/年</td>
    </tr>
    <tr>
      <td>1年</td>
      <td>1ミリ秒</td>
      <td>0.1%</td>
      <td>7900件/年</td>
    </tr>
    <tr>
      <td>1年</td>
      <td>1ミリ秒</td>
      <td>0.01%</td>
      <td>2500件/年</td>
    </tr>
  </tbody>
</table>

</i:section> <!-- @sid="numer" -->


<i:section  sid="history">
<i:title>更新履歴</i:title>
<ul>
  <li>2023-06-14: 公開</li>
</ul>
<i:p>
Permanent ID of this document: 834c86967799b6e69d4c5ea9fbb76c8b
</i:p>
</i:section> <!-- @sid="history" -->

</i:body>

<i:bibliography>
  <i:bib-entry bid="wass80" key="1">
    wass80 (2023年5月26日).
    「[訂正あり] 秒単位で衝突するファイル名をミリ秒単位に改善すると、1000倍安全になる」.
    wassのメモ書き.
    <i:url href="http://memo.wass80.xyz/2023-05-26-poisson-collision/" />,
    (2023年6月14日閲覧).
  </i:bib-entry>
</i:bibliography>

</i:article>
